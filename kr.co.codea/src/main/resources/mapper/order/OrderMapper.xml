<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.codea.order.OrderMapper">

	<!-- 1) 주문 목록 조회 (페이징) -->
	<select id="selectOrderList"
		resultType="kr.co.codea.order.OrderDto$OrderDetailView">
		SELECT
		oh.ORD_ID AS ordId,
		od.ORD_DETAIL_ID AS ordDetailId,
		i.ITEM_ID AS
		itemId,
		oh.ORD_CODE AS ordCode,
		TRUNC(oh.ORDER_DATE) AS orderDate,
		oh.REMARK AS remark,
		od.REMARK AS orderDetailRemark,
		oh.STATUS AS
		status,
		bp.BP_NAME AS bpName,
		i.ITEM_NAME AS productName,
		od.ORDER_QTY AS
		orderQty,
		inv.CURRENT_QTY AS stockQty,
		inv.WH_ID AS whId,
		od.REQUIRED_DELIVERY_DATE AS requiredDate
		FROM ORD_HEADER oh
		JOIN
		BUSINESS_PARTNER bp ON oh.BP_ID = bp.BP_ID
		JOIN ORD_DETAIL od ON
		oh.ORD_ID = od.ORD_ID
		JOIN ITEM i ON od.ITEM_ID = i.ITEM_ID
		LEFT JOIN
		INVENTORY inv ON od.ITEM_ID = inv.ITEM_ID
		WHERE 1 = 1
		<if test="keyword != null and keyword != ''">
			AND (bp.BP_NAME LIKE '%' || #{keyword} || '%'
			OR
			i.ITEM_NAME LIKE '%' || #{keyword} || '%')
		</if>
		<if test="status != null and status != ''">
			AND oh.STATUS = #{status}
		</if>
		<if test="startDate != null and startDate != ''">
			AND TRUNC(oh.ORDER_DATE) &gt;= TO_DATE(#{startDate},
			'YYYY-MM-DD')
		</if>
		<if test="endDate != null and endDate != ''">
			AND TRUNC(oh.ORDER_DATE) &lt;= TO_DATE(#{endDate},
			'YYYY-MM-DD')
		</if>
		ORDER BY oh.ORDER_DATE DESC, oh.ORD_ID, od.ORD_DETAIL_ID
		OFFSET
		#{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>

	<!-- 2) 주문 총 개수 조회 -->
	<select id="orderCount" resultType="int">
		SELECT COUNT(DISTINCT oh.ORD_ID)
		FROM ORD_HEADER oh
		JOIN
		BUSINESS_PARTNER bp ON oh.BP_ID = bp.BP_ID
		<if test="keyword != null and keyword != ''">
			JOIN ORD_DETAIL od ON oh.ORD_ID = od.ORD_ID
			JOIN ITEM i ON
			od.ITEM_ID = i.ITEM_ID
		</if>
		WHERE 1 = 1
		<if test="keyword != null and keyword != ''">
			AND (bp.BP_NAME LIKE '%' || #{keyword} || '%'
			OR
			i.ITEM_NAME LIKE '%' || #{keyword} || '%')
		</if>
		<if test="status != null and status != ''">
			AND oh.STATUS = #{status}
		</if>
		<if test="startDate != null and startDate != ''">
			AND TRUNC(oh.ORDER_DATE) &gt;= TO_DATE(#{startDate},
			'YYYY-MM-DD')
		</if>
		<if test="endDate != null and endDate != ''">
			AND TRUNC(oh.ORDER_DATE) &lt;= TO_DATE(#{endDate},
			'YYYY-MM-DD')
		</if>
	</select>

	<!-- 3) INOUT 테이블에 가출고 정보 삽입 -->
	<insert id="insertProvisionalShipmentToInOut"
		parameterType="kr.co.codea.order.OrderDto$ProvisionalShipmentRequest">
		INSERT INTO INOUT (
		INOUT_TYPE, -- 가출고 유형 (공통코드: 24)
		ITEM_ID,
		QUANTITY,
		SOURCE_DOC_TYPE, -- 주문 유형 (공통코드: 42)
		SOURCE_DOC_HEADER_ID,
		SOURCE_DOC_DETAIL_ID,
		WH_ID,
		EMP_ID,
		REMARK
		) VALUES
		(
		24, -- 가출고 공통 코드 ID
		#{itemId},
		#{quantity},
		42, -- 주문(SO) 공통 코드 ID
		#{ordId},
		#{orderDetailId},
		#{whId},
		#{empId, jdbcType=NUMERIC},
		#{remark, jdbcType=VARCHAR}
		)
	</insert>

	<!-- OrderMapper.xml 에 추가 -->
	<select id="selectOrderHeaderStatus" resultType="string">
		SELECT STATUS
		FROM ORD_HEADER
		WHERE ORD_ID = #{ordId}
	</select>


	<!-- 현재 ORD_DETAIL의 상태 조회 -->
	<select id="selectOrderDetailStatus" resultType="string">
		SELECT STATUS
		FROM ORD_DETAIL
		WHERE ORD_DETAIL_ID = #{ordDetailId}
	</select>

	<!-- ORD_DETAIL 상태를 '완료'로 업데이트 -->
	<update id="updateOrderDetailStatusToCompleted">
		UPDATE ORD_DETAIL
		SET STATUS = '완료'
		WHERE ORD_DETAIL_ID
		= #{ordDetailId}
	</update>

	<!-- 같은 ORD_ID에서 아직 완료되지 않은 상세 개수 조회 -->
	<select id="countRemainingOrderDetail" resultType="int">
		SELECT
		COUNT(*)
		FROM ORD_DETAIL
		WHERE ORD_ID = #{ordId}
		AND STATUS != '완료'
	</select>

	<!-- ORD_HEADER 상태를 '완료'로 바꾸기 -->
	<update id="updateOrderHeaderStatusToCompleted">
		UPDATE ORD_HEADER
		SET STATUS = '완료'
		WHERE ORD_ID =
		#{ordId}
	</update>

	<!-- ORD_HEADER 상태를 '진행중'으로 바꾸기 -->
	<update id="updateOrderHeaderStatusToInProgress">
		UPDATE ORD_HEADER
		SET STATUS = '진행중'
		WHERE ORD_ID =
		#{ordId}
	</update>


</mapper>
