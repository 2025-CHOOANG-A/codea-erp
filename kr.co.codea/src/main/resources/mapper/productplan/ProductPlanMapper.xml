<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.codea.productplan.ProductPlanMapper">


<!--생산계획 수정  -->
<update id="productPlanUpdate">
UPDATE PRODUCTION_PLAN
SET
    ITEM_CODE = #{itemCode},
    PLAN_QTY = #{planQty},
    START_DATE = #{startDate},
    DUE_DATE = #{dueDate},
    STATUS = #{status},
    REMARK = #{remark},
    EMP_NO = #{empNo}
WHERE
    PLAN_ID = #{planId}
</update>


<!--생산계획 생성  -->
<insert id="insertProductPlan">
INSERT INTO PRODUCTION_PLAN 
(ITEM_CODE,START_DATE,DUE_DATE,PLAN_QTY,EMP_NO,REMARK)
VALUES (
#{itemCode},#{startDate, jdbcType=DATE},#{dueDate, jdbcType=DATE},#{planQty},#{empNo},#{remark}
)
</insert>


<!--아이템 코드 조회 api  -->
      <select id="searchItem" resultType="kr.co.codea.productplan.ProductPlanDTO"> 
        SELECT
            ITEM_CODE, ITEM_NAME FROM
            ITEM  <where>
            <if test="query != null and !query.isEmpty()">
                (LOWER(ITEM_CODE) LIKE '%' || LOWER(#{query}) || '%' OR
                 LOWER(ITEM_NAME) LIKE '%' || LOWER(#{query}) || '%')
            </if>
        </where>
        ORDER BY ITEM_NAME ASC
    </select>


<!--생산계획 상세 by planId  -->
    <select id="productPlanDetail" resultType="kr.co.codea.productplan.ProductPlanDTO">
        SELECT
            PP.PLAN_ID,
             PP.ITEM_CODE,
             PP.PLAN_QTY,
             PP.START_DATE,
              PP.DUE_DATE,
              PP.COMPLETION_DATE,
              PP.ACTUAL_QTY,
              PP.STATUS,
              PP.EMP_NO,
              PP.REMARK,
              I.ITEM_NAME,
              E.EMP_NAME
            FROM
            PRODUCTION_PLAN PP    LEFT JOIN
            ITEM I ON PP.ITEM_CODE = I.ITEM_CODE    LEFT JOIN
            EMPLOYEE E ON PP.EMP_NO = E.EMP_NO      WHERE
            PP.PLAN_ID = #{planId}  </select>



<!-- 생산계획 조회 -->
    <select id="ProductPlanList" parameterType="kr.co.codea.productplan.ProductPlanDTO" resultType="kr.co.codea.productplan.ProductPlanDTO">
SELECT
	    PP.PLAN_ID,
	    PP.ITEM_CODE,
	    I.ITEM_NAME,
	    PP.START_DATE,
	    PP.DUE_DATE,
	    PP.COMPLETION_DATE, 
	    PP.PLAN_QTY,
	    PP.ACTUAL_QTY,       
	    PP.STATUS,
	    PP.REMARK,
	    PP.EMP_NO
	FROM
	    PRODUCTION_PLAN PP
	JOIN
	    ITEM I ON PP.ITEM_CODE = I.ITEM_CODE
    <where>
        <if test="keyword != null and keyword != ''">
            AND (
                PP.PLAN_ID LIKE '%' || #{keyword} || '%'
                OR I.ITEM_NAME LIKE '%' || #{keyword} || '%'
            )
        </if>
        <if test="startDate != null">
            AND PP.START_DATE >= #{startDate}
        </if>
        <if test="endDate != null">
            AND PP.DUE_DATE &lt;= #{endDate}
        </if>
        <if test="status != null and status != ''">
            AND PP.STATUS = #{status}
        </if>
        <if test="empNo != null and empNo != ''">
            AND PP.EMP_NO = #{empNo}
        </if>
    </where>
    ORDER BY PP.PLAN_ID DESC
    </select>
</mapper>