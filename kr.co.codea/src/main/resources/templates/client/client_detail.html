<div th:fragment="contentFragment" class="client-detail-container">
    <th:block th:fragment="headFragment">
        <link rel="stylesheet" th:href="@{/css/client_detail.css}"/>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    </th:block>
    <main class="container">
        <div class="detail-bg-white">
            <h2 class="fw-bold mb-4 detail-title">거래처 상세 정보</h2>

            <div class="detail-section-title mb-3">거래처 정보</div>
            <table class="table table-bordered table-detail company-table table-hover">
                <tbody>
                <tr>
                    <th scope="row">거래처 코드</th>
                    <td th:text="${client.bpCode}"></td>
                </tr>
                <tr>
                    <th scope="row">거래처 유형</th>
                    <td th:text="${client.bpType}"></td>
                </tr>
                <tr>
                    <th scope="row">거래처명</th>
                    <td th:text="${client.bpName}"></td>
                </tr>
                <tr>
                    <th scope="row">대표자명</th>
                    <td th:text="${client.ceoName}"></td>
                </tr>
                <tr>
                    <th scope="row">사업자 번호</th>
                    <td th:text="${client.bizNo}"></td>
                </tr>
                <tr>
                    <th scope="row">업태</th>
                    <td th:text="${client.bizCond}"></td>
                </tr>
                <tr>
                    <th scope="row">종목</th>
                    <td th:text="${client.bizType}"></td>
                </tr>
                <tr>
                    <th scope="row">전화번호</th>
                    <td th:text="${client.tel}"></td>
                </tr>
                <tr>
                    <th scope="row">팩스번호</th>
                    <td th:text="${client.fax}"></td>
                </tr>
                <tr>
                    <th scope="row">주소</th>
                    <td th:text="${client.address + ' ' + client.addressDetail}"></td>
                </tr>
                <tr>
                    <th scope="row">우편번호</th>
                    <td th:text="${client.postCode}"></td>
                </tr>
                <tr>
                    <th scope="row">비고</th>
                    <td th:text="${client.remark}"></td>
                </tr>
                </tbody>
            </table>

            <div class="detail-section-title d-flex justify-content-between align-items-center mb-3">
                <span>담당자 정보</span>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addContactModal">
                    <i class="bi bi-person-plus-fill me-1"></i> 담당자 추가
                </button>
            </div>
            <div th:if="${client.contacts == null or client.contacts.isEmpty()}" class="alert alert-info" role="alert">
                등록된 담당자가 없습니다.
            </div>
            <div th:unless="${client.contacts == null or client.contacts.isEmpty()}">
                <table class="table table-bordered table-striped contact-table table-sm table-hover">
                    <thead>
                    <tr>
                        <th class="text-center">이름</th>
                        <th class="text-center">직책</th>
                        <th class="text-center">전화번호</th>
                        <th class="text-center">휴대폰</th>
                        <th class="text-center">이메일</th>
                        <th class="text-center">비고</th>
                        <th class="text-center" style="width: 150px;">관리</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="contact : ${client.contacts}">
                        <td th:text="${contact.bcName}"></td>
                        <td th:text="${contact.bcPosition}"></td>
                        <td th:text="${contact.tel}"></td>
                        <td th:text="${contact.hp}"></td>
                        <td th:text="${contact.email}"></td>
                        <td th:text="${contact.remark}"></td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-dark me-1"
                                    th:data-bc-id="${contact.bcId}"
                                    th:data-bc-name="${contact.bcName}"
                                    th:data-bc-position="${contact.bcPosition}"
                                    th:data-bc-tel="${contact.tel}"       th:data-bc-hp="${contact.hp}"         th:data-bc-email="${contact.email}"   th:data-bc-remark="${contact.remark}" onclick="openEditContactModal(this)">
                                <i class="bi bi-pencil-square"></i> 수정
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    th:onclick="|deleteContact(${contact.bcId})|">
                                <i class="bi bi-trash"></i> 삭제
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end mt-5 gap-2">
                <a th:href="@{/client}" class="btn btn-secondary btn-list">
                    <i class="bi bi-card-list me-1"></i> 목록
                </a>
                <a th:href="@{/client/{id}/edit(id=${client.bpId})}" class="btn btn-dark">
                    <i class="bi bi-pencil me-1"></i> 거래처 정보 수정
                </a>
            </div>
        </div>
    </main>

    <div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="addContactForm" th:data-bp-id="${client.bpId}">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addContactModalLabel">새 담당자 추가</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="bcName" class="form-label">이름<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="bcName" name="bcName" required />
                        </div>
                        <div class="mb-3">
                            <label for="bcPosition" class="form-label">직책</label>
                            <input type="text" class="form-control" id="bcPosition" name="bcPosition" />
                        </div>
                        <div class="mb-3">
                            <label for="contactTel" class="form-label">전화번호</label>
                            <input type="text" class="form-control" id="contactTel" name="tel" />
                        </div>
                        <div class="mb-3">
                            <label for="contactHp" class="form-label">휴대폰</label>
                            <input type="text" class="form-control" id="contactHp" name="hp" />
                        </div>
                        <div class="mb-3">
                            <label for="contactEmail" class="form-label">이메일</label>
                            <input type="email" class="form-control" id="contactEmail" name="email" />
                        </div>
                        <div class="mb-3">
                            <label for="contactRemark" class="form-label">비고</label>
                            <textarea class="form-control" id="contactRemark" name="remark" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="submit" class="btn btn-primary">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editContactModal" tabindex="-1" aria-labelledby="editContactModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="editContactForm">
                    <input type="hidden" id="editBcId" name="bcId" />
                    <div class="modal-header">
                        <h5 class="modal-title" id="editContactModalLabel">담당자 정보 수정</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editBcName" class="form-label">이름<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editBcName" name="bcName" required />
                        </div>
                        <div class="mb-3">
                            <label for="editBcPosition" class="form-label">직책</label>
                            <input type="text" class="form-control" id="editBcPosition" name="bcPosition" />
                        </div>
                        <div class="mb-3">
                            <label for="editContactTel" class="form-label">전화번호</label>
                            <input type="text" class="form-control" id="editContactTel" name="tel" />
                        </div>
                        <div class="mb-3">
                            <label for="editContactHp" class="form-label">휴대폰</label>
                            <input type="text" class="form-control" id="editContactHp" name="hp" />
                        </div>
                        <div class="mb-3">
                            <label for="editContactEmail" class="form-label">이메일</label>
                            <input type="email" class="form-control" id="editContactEmail" name="email" />
                        </div>
                        <div class="mb-3">
                            <label for="editContactRemark" class="form-label">비고</label>
                            <textarea class="form-control" id="editContactRemark" name="remark" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="submit" class="btn btn-primary">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script th:inline="javascript">
        /*<![CDATA[*/
        // 모든 input 태그에 self-closing slash 추가 (Thymeleaf 파싱 문제 방지)
        // 이 부분은 HTML 코드 자체에서 수정하는 것이 더 좋습니다.
        // 예를 들어 <input type="text" ...> 를 <input type="text" ... /> 로 변경

        function deleteContact(bcId) {
            if (confirm('정말로 이 담당자를 삭제하시겠습니까?')) {
                const bpId = /*[[${client.bpId}]]*/ null; // 클라이언트 BP_ID 가져오기
                fetch(`/client/${bpId}/contact/${bcId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        // CSRF 토큰이 필요하다면 여기에 추가 (예: Spring Security 사용 시)
                        // 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content,
                    },
                })
                .then(response => {
                    if (response.ok) {
                        alert('담당자가 성공적으로 삭제되었습니다.');
                        location.reload(); // 페이지 새로고침
                    } else {
                        alert('담당자 삭제에 실패했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('네트워크 오류가 발생했습니다.');
                });
            }
        }

        function openEditContactModal(button) {
            const bcId = button.dataset.bcId;
            const bcName = button.dataset.bcName;
            const bcPosition = button.dataset.bcPosition;
            const tel = button.dataset.bcTel;
            const hp = button.dataset.bcHp;
            const email = button.dataset.bcEmail;
            const remark = button.dataset.bcRemark;

            document.getElementById('editBcId').value = bcId;
            document.getElementById('editBcName').value = bcName;
            document.getElementById('editBcPosition').value = bcPosition;
            document.getElementById('editContactTel').value = tel;
            document.getElementById('editContactHp').value = hp;
            document.getElementById('editContactEmail').value = email;
            document.getElementById('editContactRemark').value = remark;

            const bpId = /*[[${client.bpId}]]*/ null;
            // 폼의 action URL 설정 (PATCH 요청을 위해)
            document.getElementById('editContactForm').action = `/client/${bpId}/contact/${bcId}`;
            // 이 줄은 제거하거나 주석 처리해야 합니다.
            // document.getElementById('editContactForm').method = 'post';

            const editContactModal = new bootstrap.Modal(document.getElementById('editContactModal'));
            editContactModal.show();
        }
        /*]]>*/
    </script>
</div>
