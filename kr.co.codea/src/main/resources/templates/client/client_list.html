<div th:fragment="contentFragment">

<th:block th:fragment="headFragment">
    <link rel="stylesheet" th:href="@{/css/client_list.css}" />
</th:block>
    
    <main id="mainContent" class="main-content">
      <div class="container-fluid px-0">
        <h2>거래처 목록</h2> 
        <form class="filter-bar mb-3" id="filterForm" autocomplete="off" onsubmit="return false;">
          <select class="form-select" id="typeFilter" name="bpType"> 
            <option value="">거래처유형 전체</option> <option value="고객사" th:selected="${searchDto.bpType == '고객사'}">고객사</option>
            <option value="구매처" th:selected="${searchDto.bpType == '구매처'}">구매처</option>
            <option value="매입매출처" th:selected="${searchDto.bpType == '매입매출처'}">매입매출처</option>
          </select>
          <input type="text" name="keyword" class="form-control" id="searchInput" placeholder="코드, 거래처명 등 검색" th:value="${searchDto.keyword}" />
          <button type="button" class="btn btn-primary" id="searchBtn">
            검색
          </button>
        </form>

        <div class="table-responsive">
          <table
            class="table table-bordered align-middle mb-0"
            id="clientTable" >
            <thead>
              <tr>
                <th style="width:60px;">no</th> <th>코드</th>
                <th>거래처명</th>
                <th>유형</th>
                <th>사업자번호</th>
                <th>전화</th>
                <th>주소</th>
                <th style="width:100px;">비고</th> </tr>
            </thead>
					<tbody id="clientTableBody">
				  <tr th:if="${clients.isEmpty()}" id="noDataRow">
				      <td colspan="8" class="text-center text-secondary">데이터가 없습니다.</td>
				  </tr>
				  <th:block th:unless="${clients.isEmpty()}">
				    <tr th:each="client, i : ${clients}">
				      <td th:text="${i.size - i.index}"></td>
				      <td th:text="${client.bpCode}"></td>
				      <td>
				        <a th:href="@{'/client/' + ${client.bpId}}" class="name-link" th:text="${client.bpName}"></a>
				      </td>
				      <td th:text="${client.bpType}"></td>
				      <td th:text="${client.bizNo}"></td>
				      <td th:text="${client.bp_tel}"></td>
				      <td th:text="${client.address}"></td>
				      <td>
				          <span th:unless="${client.bp_remark}">-</span>
				          <button type="button" class="btn btn-outline-secondary btn-sm btn-remark"
				                  th:if="${client.bp_remark}" th:data-remark="${client.bp_remark}" th:text="내용 확인"></button>
				      </td>
				    </tr>
				  </th:block>
				</tbody>

          </table>
        </div>

        <div class="table-footer mt-3">
          <a href="./client/write" class="btn btn-success" id="addBtn">추가</a>
        </div>
      </div>
    </main>

    <div
      class="modal fade"
      id="remarkModal"
      tabindex="-1"
      aria-labelledby="remarkModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="remarkModalLabel">비고 내용</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="닫기"
            ></button>
          </div>
          <div class="modal-body" id="remarkModalBody">
            </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    
      // 사이드바 관련 함수/변수들은 이제 sidebar.js에서 전역으로 관리되므로, 여기서는 제거합니다.
      // mousedown 이벤트 리스너도 sidebar.js에서 처리하도록 옮겼습니다.
      // handleSidebarState 함수도 sidebar.js에서 처리하므로 여기서 제거합니다.
      // window.addEventListener("resize", handleSidebarState); 도 sidebar.js로 옮겼습니다.
      // document.addEventListener("DOMContentLoaded", handleSidebarState); 도 sidebar.js로 옮겼습니다.


      // DOMContentLoaded는 한 번만 사용하고, 모든 DOM 조작 및 이벤트 리스너 등록을 그 안에 넣습니다.
      document.addEventListener("DOMContentLoaded", function() {
          // 비고 모달 및 거래처명 링크 관련 이벤트 리스너 (기존 코드 유지)
          document
            .getElementById("clientTableBody")
            .addEventListener("click", function (e) {
              if (e.target.classList.contains("btn-remark")) {
                const remark = e.target.getAttribute("data-remark");
                document.getElementById("remarkModalBody").textContent = remark;
                const modal = new bootstrap.Modal(
                  document.getElementById("remarkModal")
                );
                modal.show();
              }
               if (e.target.classList.contains("name-link")) {
                 console.log("거래처명 링크 클릭:", e.target.textContent);
                 console.log("이동할 URL:", e.target.href);
               }
            });

          // ------------------ 검색 관련 JavaScript ------------------
          const searchBtn = document.getElementById("searchBtn");
          const searchInput = document.getElementById("searchInput");
          const typeFilter = document.getElementById("typeFilter");
          const filterForm = document.getElementById("filterForm");

          // 요소가 제대로 찾아졌는지 확인 (디버깅용)
          console.log("searchBtn:", searchBtn);
          console.log("searchInput:", searchInput);
          console.log("typeFilter:", typeFilter);
          console.log("filterForm:", filterForm);


          // 검색 버튼 클릭 이벤트 리스너
          if (searchBtn) { // 요소가 존재하는지 확인 후 이벤트 리스너 등록
              searchBtn.addEventListener("click", function() {
                  submitSearchForm();
              });
          }

          // input에서 Enter 키 누를 시 검색 (옵션)
          if (searchInput) {
              searchInput.addEventListener("keypress", function(e) {
                  if (e.key === 'Enter') {
                      e.preventDefault(); // 기본 Enter 동작(폼 제출) 방지
                      submitSearchForm();
                  }
              });
          }

          // select 박스 변경 시 자동 검색 (옵션)
          if (typeFilter) {
              typeFilter.addEventListener("change", function() {
                  submitSearchForm();
              });
          }

          // 폼 제출 함수
          function submitSearchForm() {
              if (filterForm) { // 폼 요소가 존재하는지 확인
                  filterForm.action = "/client"; 
                  filterForm.method = "GET";     
                  filterForm.submit();           
              } else {
                  console.error("Error: filterForm not found.");
              }
          }
          // -----------------------------------------------------------

      }); // DOMContentLoaded 닫는 괄호
    </script>
</div>