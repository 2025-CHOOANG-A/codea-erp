<div th:fragment="contentFragment">

    <th:block th:fragment="headFragment">
        <link rel="stylesheet" th:href="@{/css/storage_list.css}" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    </th:block>

    <main class="content">
        <div class="container">
            <h2 class="mb-4">생산 계획</h2>

            <div class="flex justify-end gap-2 mb-3">
                <button type="button" id="createWorkOrderButton" class="btn btn-primary work-order-btn">작업 지시 생성</button>
                <button type="button" class="btn btn-primary work-order-btn">작업 지시 취소</button>
                <button type="button" class="btn btn-primary mrp-calc-btn">자재 소요량 계산</button>
            </div>
            <hr class="mb-4">

            <form id="filterForm" class="filter-bar flex flex-wrap items-center gap-3 mb-4 p-3 border rounded-md shadow-sm bg-white">
                <div class="flex items-center gap-2">
                    <label for="planKeywordInput" class="text-sm text-gray-700 whitespace-nowrap">검색:</label>
                    <input
                        type="text"
                        name="keyword"
                        id="planKeywordInput"
                        class="form-control flex-grow"
                        placeholder="계획 번호, 품목 이름 검색"
                        maxlength="20"
                        th:value="${searchDto.keyword}"
                    />
                </div>

                <div class="flex items-center gap-2">
                    <label for="startDate" class="text-sm text-gray-700 whitespace-nowrap">계획 시작일:</label>
                    <input
                        type="date"
                        name="startDate"
                        id="startDate"
                        class="form-control"
                        th:value="${searchDto.startDate}"
                    />
                </div>
                <div class="flex items-center gap-2">
                    <label for="endDate" class="text-sm text-gray-700 whitespace-nowrap">계획 완료일:</label>
                    <input
                        type="date"
                        name="endDate"
                        id="endDate"
                        class="form-control"
                        th:value="${searchDto.endDate}"
                    />
                </div>

                <div class="flex items-center gap-2">
                    <label for="status" class="text-sm text-gray-700 whitespace-nowrap">상태:</label>
                    <select name="status" id="status" class="form-select" th:value="${searchDto.status}">
                        <option value="">전체</option>
                        <option value="PLANNED" th:selected="${searchDto.status == 'PLANNED'}">계획</option>
                        <option value="IN_PROGRESS" th:selected="${searchDto.status == 'IN_PROGRESS'}">진행중</option>
                        <option value="COMPLETED" th:selected="${searchDto.status == 'COMPLETED'}">완료</option>
                        <option value="CANCELLED" th:selected="${searchDto.status == 'CANCELLED'}">취소</option>
                    </select>
                </div>

                <div class="flex items-center gap-2">
                    <label for="empNo" class="text-sm text-gray-700 whitespace-nowrap">담당자 :</label>
                    <input
                        type="text"
                        name="empNo"
                        id="empNo"
                        class="form-control"
                        placeholder="사번"
                        maxlength="10"
                        th:value="${searchDto.empNo}"
                    />
                </div>

                <button id="searchBtn" type="submit" class="btn btn-primary ml-auto">검색</button>
            </form>

            <div class="table-responsive">
                <table
                    id="productionPlanTable"
                    class="table table-hover align-middle mb-0"
                >
                    <thead class="table-light">
                        <tr>
                            <th scope="col" class="text-center">
                            </th>
                            <th scope="col">NO</th>
                            <th scope="col">생산계획 번호</th>
                            <th scope="col">품목 코드</th>
                            <th scope="col">품목 이름</th>
                            <th scope="col">생산계획시작일</th>
                            <th scope="col">생산완료계획일</th>
                            <th scope="col">실제 완료일</th>
                            <th scope="col">생산계획수량</th>
                            <th scope="col">실제 수량</th>
                            <th scope="col">상태</th>
                            <th scope="col">담당자 사번</th>
                            <th scope="col">상세</th>
                            <th scope="col">비고</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${productionPlans.isEmpty()}" id="noDataRow">
                            <td colspan="14" class="text-center text-secondary">데이터가 없습니다.</td>
                        </tr>
                        <th:block th:unless="${productionPlans.isEmpty()}">
                            <tr th:each="plan, i : ${productionPlans}">
                                <td class="text-center">
                                    <input type="checkbox" class="row-checkbox form-check-input" th:data-plan-id="${plan.planId}">
                                </td>
                                <td th:text="${i.size - i.index}"></td>
                                <td th:text="${plan.planId}"></td>
                                <td th:text="${plan.itemCode}"></td>
                                <td th:text="${plan.itemName}"></td>
                                <td th:text="${plan.startDate}"></td>
                                <td th:text="${plan.dueDate}"></td>
                                <td th:text="${plan.completionDate ?: '-'}"></td>
                                <td th:text="${plan.planQty}"></td>
                                <td th:text="${plan.actualQty}"></td>
                                <td th:text="${plan.status}"></td>
                                <td th:text="${plan.empNo}"></td>
                                <td>
                                    <button type="button" class="btn btn-info btn-sm detail-edit-btn"
                                            th:data-plan-id="${plan.planId}"
                                            data-bs-toggle="modal"
                                            data-bs-target="#productionPlanRegisterModal"
                                            data-mode="detail"> 상세
                                    </button>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-outline-secondary btn-sm remark-btn"
                                            th:data-remark="${plan.remark}"
                                            th:text="'비고 보기'"
                                            data-bs-toggle="modal"
                                            data-bs-target="#remarkModal">
                                    </button>
                                </td>
                            </tr>
                        </th:block>
                    </tbody>
                </table>
            </div>

            <div class="table-footer-row flex justify-between items-center mt-4">
                <nav>
                    <ul id="pagination" class="pagination justify-content-center mb-0">
                    </ul>
                </nav>
                <div class="flex gap-2">
                    <a href="#" class="btn btn-primary add-btn" data-bs-toggle="modal" data-bs-target="#productionPlanRegisterModal"
                       data-mode="register">생산 계획 등록</a>
                       
<!--                     <button type="button" class="btn btn-outline-danger delete-btn">
                        선택된 계획 삭제
                    </button> -->
                </div>
            </div>
        </div>
    </main>


    <div class="modal fade" id="productionPlanRegisterModal" tabindex="-1" aria-labelledby="productionPlanRegisterModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productionPlanRegisterModalLabel">생산 계획 등록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>
                <div class="modal-body">
                    <form id="productionPlanForm">
                        <div class="mb-3">
                            <label for="itemNameDisplay" class="form-label">품목</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="itemNameDisplay" placeholder="선택된 품목명" readonly>
                                <input type="hidden" id="itemCode" name="itemCode">
                                <button class="btn btn-primary" type="button" id="openItemSearchInputBtn">품목 검색</button>
                            </div>
                        </div>

                        <div id="itemSearchSection" class="card card-body mb-3" style="display: none;">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="itemSearchInput" placeholder="품목명 또는 품목 코드 입력">
                                <button class="btn btn-primary" type="button" id="executeItemSearchBtn">검색</button>
                            </div>
                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>품목명</th>
                                            <th>품목 코드</th>
                                            <th>선택</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemSearchResults">
                                        <tr><td colspan="3" class="text-center text-secondary">검색 결과가 없습니다.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="modalPlanQty" class="form-label">계획 수량</label>
                            <input type="number" class="form-control" id="modalPlanQty" name="planQty" required>
                        </div>
                        <div class="mb-3">
                            <label for="modalStartDate" class="form-label">생산계획시작일</label>
                            <input type="date" class="form-control" id="modalStartDate" name="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="modalDueDate" class="form-label">생산완료계획일</label>
                            <input type="date" class="form-control" id="modalDueDate" name="dueDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalCompletionDate" class="form-label">실제생산완료일</label>
                            <input type="date" class="form-control" id="modalCompletionDate" name="completionDate">
                        </div>
                        <div class="mb-3">
                            <label for="modalActualQty" class="form-label">실제생산수량</label>
                            <input type="number" class="form-control" id="modalActualQty" name="actualQty">
                        </div>
                        <div class="mb-3">
                            <label for="modalStatus" class="form-label">상태</label>
                            <select name="status" id="modalStatus" class="form-select">
                                <option value="계획">계획</option>
                                <option value="자재계획완료">자재계획완료</option>
                                <option value="작업지시">작업지시</option>
                                <option value="완료">완료</option>
                                <option value="취소">취소</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">담당자</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="empNameDisplay" placeholder="선택된 사원명" readonly>
                                <input type="hidden" id="modalEmpNo" name="empNo">
                                <button class="btn btn-primary" type="button" id="openEmployeeSearchInputBtn">사원 검색</button>
                            </div>
                        </div>

                        <div id="employeeSearchSection" class="card card-body mb-3" style="display: none;">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="employeeSearchInput" placeholder="사원명 또는 사번 입력">
                                <button class="btn btn-primary" type="button" id="executeEmployeeSearchBtn">검색</button>
                            </div>
                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>사원명</th>
                                            <th>사번</th>
                                            <th>선택</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employeeSearchResults">
                                        <tr><td colspan="3" class="text-center text-secondary">검색 결과가 없습니다.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="remark" class="form-label">비고</label>
                            <input type="text" class="form-control" id="remark" name="remark">
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary" id="modalSubmitButton">등록</button>
                            <button type="button" class="btn btn-secondary ms-2" data-bs-dismiss="modal">취소</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="remarkModal" tabindex="-1" aria-labelledby="remarkModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="remarkModalLabel">비고 내용</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="modalRemarkContent"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script th:src="@{/js/productplan_list.js}"></script> 
</div>