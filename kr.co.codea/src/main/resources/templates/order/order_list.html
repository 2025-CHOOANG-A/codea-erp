<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>주문 목록</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 테이블 셀 수직 정렬 */
        .table td {
            vertical-align: middle;
        }
        
        /* 병합된 셀의 텍스트 중앙 정렬 */
        .table .merged-cell {
            text-align: center;
            vertical-align: middle;
        }
        
        /* 상태 배지 스타일 개선 */
        .status-badge {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
        
        /* 검색 폼 여백 조정 */
        .search-form {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1.5rem;
        }
        
        /* 페이징 여백 */
        .pagination-wrapper {
            margin: 2rem 0;
        }
        
        /* 주문 등록 버튼 여백 */
        .register-button {
            margin-top: 1rem;
            margin-bottom: 2rem;
        }
        
        /* 숨겨진 셀 스타일 */
        .order-header[style*="display: none"] {
            display: none !important;
        }
        
        /* 출고 버튼 스타일 */
        .shipment-btn {
            min-width: 70px;
            font-weight: 500;
        }
        
        .shipment-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* 재고부족 버튼 스타일 */
        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="container mt-4">

<h2>주문 목록</h2>

<!-- 에러 메시지 표시 -->
<div th:if="${errorMessage}" class="alert alert-danger" role="alert">
    <span th:text="${errorMessage}"></span>
</div>

<!-- 검색 폼 -->
<div class="search-form">
    <form class="row g-2" method="get" th:action="@{/order}">
        <div class="col-md-4">
            <input type="text" class="form-control" name="keyword" placeholder="거래처명 또는 제품명"
                   th:value="${param.keyword}">
        </div>
        <div class="col-md-2">
            <select class="form-select" name="status">
                <option value="">전체 상태</option>
                <option value="임시" th:selected="${param.status == '임시'}">임시</option>
                <option value="접수" th:selected="${param.status == '접수'}">접수</option>
                <option value="진행중" th:selected="${param.status == '진행중'}">진행중</option>
                <option value="완료" th:selected="${param.status == '완료'}">완료</option>
                <option value="취소" th:selected="${param.status == '취소'}">취소</option>
            </select>
        </div>
        <div class="col-md-2">
            <input type="date" class="form-control" name="startDate" th:value="${param.startDate}">
        </div>
        <div class="col-md-2">
            <input type="date" class="form-control" name="endDate" th:value="${param.endDate}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">검색</button>
        </div>
    </form>
</div>

<!-- 검색 결과 요약 -->
<div class="mb-3">
    <span class="text-muted">
        총 <strong th:text="${totalCount ?: 0}">0</strong>건 검색됨 
        (현재 페이지: <strong th:text="${currentPageSize ?: 0}">0</strong>건)
    </span>
</div>

<!-- 주문 목록 테이블 -->
<table class="table table-bordered table-hover">
    <thead class="table-light">
    <tr>
        <th>주문코드</th>
        <th>거래처</th>
        <th>주문일</th>
        <th>상태</th>
        <th>제품명</th>
        <th>주문수량</th>
        <th>보유수량</th>
        <th>납기일</th>
        <th>출고작업</th>
    </tr>
    </thead>
    <tbody>
    <!-- 데이터가 없는 경우 -->
    <tr th:if="${#lists.isEmpty(pagedOrderDetails.content)}">
        <td colspan="9" class="text-center text-muted py-4">
            검색 결과가 없습니다.
        </td>
    </tr>
    
    <!-- 주문 데이터 표시 -->
    <th:block th:each="order, stat : ${pagedOrderDetails.content}">
        <!-- 현재 주문이 이전 주문과 다른지 체크 (첫 번째 상세인지 확인) -->
        <th:block th:with="isFirstDetail=${stat.index == 0 or order.ordId != pagedOrderDetails.content[stat.index - 1]?.ordId}">
            
            <tr th:attr="data-order-id=${order.ordId}">
                <!-- 주문 헤더 정보 (모든 행에 셀은 출력하되 내용은 첫 번째에만) -->
                <td th:text="${isFirstDetail ? order.ordCode : ''}" class="order-header merged-cell" data-type="orderCode"></td>
                <td th:text="${isFirstDetail ? order.bpName : ''}" class="order-header merged-cell" data-type="bpName"></td>
                <td th:text="${isFirstDetail ? #temporals.format(order.orderDate, 'yyyy-MM-dd') : ''}" class="order-header merged-cell" data-type="orderDate"></td>
                <td class="order-header merged-cell" data-type="status">
                    <span th:if="${isFirstDetail}" class="badge status-badge" 
                          th:classappend="${order.status == '완료'} ? 'bg-success' : 
                                         (${order.status == '진행중'} ? 'bg-primary' : 
                                         (${order.status == '접수'} ? 'bg-info' : 
                                         (${order.status == '취소'} ? 'bg-danger' : 'bg-secondary')))"
                          th:text="${order.status}"></span>
                </td>
                
                <!-- 주문 상세 정보 (모든 행에 표시) -->
                <td th:text="${order.productName}"></td>
                <td th:text="${#numbers.formatInteger(order.orderQty, 0, 'COMMA')}" class="text-end"></td>
                <td th:text="${order.stockQty != null ? #numbers.formatInteger(order.stockQty, 0, 'COMMA') : '-'}" class="text-end"></td>
                <td th:text="${order.requiredDate != null ? #temporals.format(order.requiredDate, 'yyyy-MM-dd') : '-'}"></td>
                <td class="text-center">
                    <!-- 출고 버튼 (보유수량이 주문수량보다 크거나 같을 때만 활성화) -->
                    <th:block th:if="${order.stockQty != null and order.stockQty >= order.orderQty}">
                        <button type="button" class="btn btn-primary btn-sm shipment-btn" 
                                th:attr="data-order-id=${order.ordId}, 
                                         data-product-name=${order.productName},
                                         data-order-qty=${order.orderQty},
                                         data-stock-qty=${order.stockQty}"
                                onclick="handleShipment(this)">
                            <i class="bi bi-truck"></i> 출고
                        </button>
                    </th:block>
                    <th:block th:if="${order.stockQty == null or order.stockQty < order.orderQty}">
                        <button type="button" class="btn btn-secondary btn-sm" disabled>
                            <i class="bi bi-exclamation-triangle"></i> 재고부족
                        </button>
                    </th:block>
                </td>
            </tr>
        </th:block>
    </th:block>
    </tbody>
</table>

<!-- 페이징 -->
<div class="d-flex justify-content-center align-items-center pagination-wrapper">
    <nav th:if="${pagedOrderDetails.totalPages > 1}">
        <ul class="pagination mb-0">
            <!-- 이전 페이지 -->
            <li class="page-item" th:classappend="${pagedOrderDetails.currentPage == 0} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/order(page=${pagedOrderDetails.currentPage - 1}, keyword=${param.keyword}, status=${param.status}, startDate=${param.startDate}, endDate=${param.endDate})}">이전</a>
            </li>
            
            <!-- 페이지 번호들 -->
            <li th:each="i : ${#numbers.sequence(0, pagedOrderDetails.totalPages - 1)}"
                class="page-item" 
                th:classappend="${pagedOrderDetails.currentPage == i} ? 'active'">
                <a class="page-link" 
                   th:href="@{/order(page=${i}, keyword=${param.keyword}, status=${param.status}, startDate=${param.startDate}, endDate=${param.endDate})}" 
                   th:text="${i + 1}">1</a>
            </li>
            
            <!-- 다음 페이지 -->
            <li class="page-item" th:classappend="${pagedOrderDetails.currentPage == pagedOrderDetails.totalPages - 1} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/order(page=${pagedOrderDetails.currentPage + 1}, keyword=${param.keyword}, status=${param.status}, startDate=${param.startDate}, endDate=${param.endDate})}">다음</a>
            </li>
        </ul>
    </nav>
</div>

<!-- 주문 등록 버튼 (하단에 배치) -->
<div class="d-flex justify-content-end register-button">
    <a th:href="@{/order/register}" class="btn btn-success btn-lg">
        <i class="bi bi-plus-circle me-2"></i>주문 등록
    </a>
</div>

<!-- Bootstrap JavaScript (Optional - 필요시 사용) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 커스텀 JavaScript -->
<script>
    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', function() {
        // 테이블 rowspan 처리를 JavaScript로 수행
        processTableRowspan();
        
        // 출고 버튼 상태 업데이트
        updateShipmentButtons();
        
        // 검색 폼 초기화 기능
        const resetButton = document.getElementById('resetSearchForm');
        if (resetButton) {
            resetButton.addEventListener('click', function() {
                document.querySelector('form').reset();
                window.location.href = '/order';
            });
        }
        
        // 테이블 행 hover 효과
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f8f9fa';
            });
            row.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });
        
        // 숫자 포맷팅 확인 (이미 서버에서 처리되지만 클라이언트에서도 확인)
        const numberCells = document.querySelectorAll('.text-end');
        numberCells.forEach(cell => {
            const text = cell.textContent.trim();
            if (text !== '-' && !isNaN(text.replace(/,/g, ''))) {
                cell.style.fontFamily = 'monospace';
            }
        });
    });
    
    // 테이블 rowspan 처리 함수
    function processTableRowspan() {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length === 0) return;
        
        // 주문 ID별로 그룹핑
        const orderGroups = {};
        
        rows.forEach((row, index) => {
            const orderId = row.getAttribute('data-order-id');
            if (!orderId) return;
            
            if (!orderGroups[orderId]) {
                orderGroups[orderId] = [];
            }
            orderGroups[orderId].push({row, index});
        });
        
        // 각 주문 그룹에 대해 rowspan 처리
        Object.values(orderGroups).forEach(group => {
            if (group.length <= 1) return;
            
            const firstRow = group[0].row;
            const rowspan = group.length;
            
            // 첫 번째 행의 주문 헤더 셀들에 rowspan 적용
            const headerCells = firstRow.querySelectorAll('.order-header');
            headerCells.forEach(cell => {
                cell.rowSpan = rowspan;
            });
            
            // 나머지 행들의 주문 헤더 셀들 숨기기
            for (let i = 1; i < group.length; i++) {
                const row = group[i].row;
                const headerCells = row.querySelectorAll('.order-header');
                headerCells.forEach(cell => {
                    cell.style.display = 'none';
                });
            }
        });
    }
    
    // 출고 처리 함수
    function handleShipment(button) {
        const orderId = button.getAttribute('data-order-id');
        const productName = button.getAttribute('data-product-name');
        const orderQty = button.getAttribute('data-order-qty');
        const stockQty = button.getAttribute('data-stock-qty');
        
        // 확인 메시지
        const message = `출고 처리하시겠습니까?\n\n제품명: ${productName}\n주문수량: ${Number(orderQty).toLocaleString()}개\n보유수량: ${Number(stockQty).toLocaleString()}개`;
        
        if (confirm(message)) {
            // 버튼 상태 변경 (로딩 상태)
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>처리중...';
            
            // 실제 출고 처리 API 호출 (예시)
            fetch('/api/shipment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    orderId: orderId,
                    productName: productName,
                    orderQty: orderQty
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 성공 시
                    button.className = 'btn btn-success btn-sm';
                    button.innerHTML = '<i class="bi bi-check-circle"></i> 완료';
                    
                    // 성공 알림
                    alert('출고 처리가 완료되었습니다.');
                    
                    // 페이지 새로고침 또는 데이터 업데이트
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    // 실패 시
                    throw new Error(data.message || '출고 처리에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('출고 처리 오류:', error);
                alert('출고 처리 중 오류가 발생했습니다: ' + error.message);
                
                // 버튼 상태 복원
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-truck"></i> 출고';
            });
        }
    }
    
    // 출고 상태 확인 및 버튼 상태 업데이트
    function updateShipmentButtons() {
        const buttons = document.querySelectorAll('.shipment-btn');
        buttons.forEach(button => {
            const orderQty = parseInt(button.getAttribute('data-order-qty'));
            const stockQty = parseInt(button.getAttribute('data-stock-qty'));
            
            // 재고 부족 시 버튼 비활성화
            if (isNaN(stockQty) || stockQty < orderQty) {
                button.disabled = true;
                button.className = 'btn btn-secondary btn-sm';
                button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> 재고부족';
            }
        });
    }
    
    // 검색 폼 유효성 검사
    function validateSearchForm() {
        const startDate = document.querySelector('input[name="startDate"]').value;
        const endDate = document.querySelector('input[name="endDate"]').value;
        
        if (startDate && endDate && startDate > endDate) {
            alert('시작일이 종료일보다 늦을 수 없습니다.');
            return false;
        }
        
        return true;
    }
    
    // 검색 폼에 유효성 검사 추가
    const searchForm = document.querySelector('form');
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            if (!validateSearchForm()) {
                e.preventDefault();
            }
        });
    }
</script>

</body>
</html>